[Unit]
Description=Tranquil Inbox Ward - Enhanced Email Classification Service
After=network.target ollama.service
Wants=network.target

[Service]
Type=simple
WorkingDirectory={INSTALL_DIR}
Environment="PATH={INSTALL_DIR}/{VENV_NAME}/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# 使用虚拟环境中的Python
# 方案A：完全使用journal日志（推荐）
ExecStart={INSTALL_DIR}/{VENV_NAME}/bin/python app.py

# 方案B：保留文件日志（如果调试时需要文件日志）
# ExecStart={INSTALL_DIR}/{VENV_NAME}/bin/gunicorn -w 4 -b 0.0.0.0:8501 --access-logfile /var/log/tranquil-inbox-ward/access.log --error-logfile /var/log/tranquil-inbox-ward/error.log app:app

# 重启策略
Restart=on-failure
RestartSec=10


# 安全设置 - 调整以允许应用访问其安装目录
NoNewPrivileges=true
PrivateTmp=true
# 从 strict 改为 full，允许对 /etc、/usr 的只读访问，但允许写入其他目录
ProtectSystem=full  
ReadWritePaths={INSTALL_DIR} 
ProtectHome=read-only 

# 日志设置 - 完全使用journal
StandardOutput=journal
StandardError=journal
SyslogIdentifier=tranquil-inbox-ward

[Install]
WantedBy=multi-user.target
